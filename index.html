<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KETEP NEWS CLOUD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDK 추가 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, runTransaction, set, remove } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDpc7drih9uhEftH8p1kczMU3NNcAwjzB4",
            authDomain: "news-385f0.firebaseapp.com",
            databaseURL: "https://news-385f0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "news-385f0",
            storageBucket: "news-385f0.firebasestorage.app",
            messagingSenderId: "991807239164",
            appId: "1:991807239164:web:338c4624b8049ac873f879",
            measurementId: "G-W18QS9LPW2"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // 방문자 카운팅 함수
        async function countVisitor() {
            const today = new Date().toISOString().split('T')[0];
            
            // 전체 방문자 수 업데이트
            const totalRef = ref(db, 'visitors/total');
            await runTransaction(totalRef, (currentTotal) => {
                return (currentTotal || 0) + 1;
            });
            
            // 오늘 방문자 수 업데이트
            const todayRef = ref(db, `visitors/daily/${today}`);
            await runTransaction(todayRef, (currentCount) => {
                return (currentCount || 0) + 1;
            });
            
            // 월별 통계를 위한 업데이트
            const yearMonth = today.substring(0, 7);
            const monthlyRef = ref(db, `visitors/monthly/${yearMonth}`);
            await runTransaction(monthlyRef, (currentCount) => {
                return (currentCount || 0) + 1;
            });
        }

        // 방문자 수 표시 업데이트 함수
        function updateVisitorDisplay() {
            const today = new Date().toISOString().split('T')[0];
            
            // 전체 방문자 수 가져오기
            const totalRef = ref(db, 'visitors/total');
            onValue(totalRef, (snapshot) => {
                document.getElementById('totalVisitors').textContent = snapshot.val() || 0;
            });
            
            // 오늘 방문자 수 가져오기
            const todayRef = ref(db, `visitors/daily/${today}`);
            onValue(todayRef, (snapshot) => {
                document.getElementById('todayVisitors').textContent = snapshot.val() || 0;
            });
        }

        // 통계 데이터 가져오기 함수
        async function getVisitorStats() {
            const dailyRef = ref(db, 'visitors/daily');
            const monthlyRef = ref(db, 'visitors/monthly');
            
            const [dailySnapshot, monthlySnapshot] = await Promise.all([
                get(dailyRef),
                get(monthlyRef)
            ]);
            
            return {
                daily: dailySnapshot.val(),
                monthly: monthlySnapshot.val()
            };
        }

        // 이메일 유효성 검사 함수
        function isValidEmail(email) {
            return email.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/);
        }

        // 구독 상태 확인 함수
        async function checkSubscriptionStatus(email) {
            try {
                if (!email) return false;
                const sanitizedEmail = email.replace(/[.#$\[\]]/g, '_');
                const subscriptionRef = ref(db, `subscribers/${sanitizedEmail}`);
                const snapshot = await get(subscriptionRef);
                return snapshot.exists();
            } catch (error) {
                console.error('구독 상태 확인 중 오류:', error);
                return false;
            }
        }

        // 버튼 상태 업데이트 함수
        function updateButtonsState(isValid) {
            const subscribeBtn = document.getElementById('subscribeBtn');
            const unsubscribeBtn = document.getElementById('unsubscribeBtn');

            if (!isValid) {
                // 유효하지 않은 이메일
                subscribeBtn.disabled = true;
                unsubscribeBtn.disabled = true;
                subscribeBtn.className = 'flex-1 py-2 text-sm text-gray-400 bg-gray-100 rounded transition-colors duration-200';
                unsubscribeBtn.className = 'flex-1 py-2 text-sm text-gray-400 bg-gray-100 rounded transition-colors duration-200';
            } else {
                // 유효한 이메일
                subscribeBtn.disabled = false;
                unsubscribeBtn.disabled = false;
                subscribeBtn.className = 'flex-1 py-2 text-sm text-white bg-green-500 hover:bg-green-600 rounded transition-colors duration-200';
                unsubscribeBtn.className = 'flex-1 py-2 text-sm text-white bg-red-500 hover:bg-red-600 rounded transition-colors duration-200';
            }
        }

        // 이메일 입력 필드 이벤트 리스너
        document.getElementById('subscriberEmail').addEventListener('input', function(e) {
            const email = e.target.value.trim();
            const isValid = isValidEmail(email);
            updateButtonsState(isValid);
        });

        // red 함수
        async function handleSubscribe() {
            const emailInput = document.getElementById('subscriberEmail');
            const email = emailInput.value.trim();

            if (!isValidEmail(email)) {
                alert('유효한 이메일 주소를 입력해주세요.');
                return;
            }

            try {
                const isSubscribed = await checkSubscriptionStatus(email);
                
                if (isSubscribed) {
                    alert('이미 구독 중입니다.');
                    return;
                }

                const sanitizedEmail = email.replace(/[.#$\[\]]/g, '_');
                const subscriptionRef = ref(db, `subscribers/${sanitizedEmail}`);

                await set(subscriptionRef, {
                    email: email,
                    timestamp: Date.now()
                });
                
                alert('구독이 완료되었습니다.');
                emailInput.value = '';
                updateButtonsState(false);
            } catch (error) {
                console.error('구독 처리 중 오류:', error);
                alert('처리 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 구독취소 함수
        async function handleUnsubscribe() {
            const emailInput = document.getElementById('subscriberEmail');
            const email = emailInput.value.trim();

            if (!isValidEmail(email)) {
                alert('유효한 이메일 주소를 입력해주세요.');
                return;
            }

            try {
                const isSubscribed = await checkSubscriptionStatus(email);
                
                if (!isSubscribed) {
                    alert('이미 구독이 취소되었습니다.');
                    return;
                }

                const sanitizedEmail = email.replace(/[.#$\[\]]/g, '_');
                const subscriptionRef = ref(db, `subscribers/${sanitizedEmail}`);

                await remove(subscriptionRef);
                
                alert('구독이 취소되었습니다.');
                emailInput.value = '';
                updateButtonsState(false);
            } catch (error) {
                console.error('구독 취소 중 오류:', error);
                alert('처리 중 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }

        // 전역 스코프에 함수 추가
        window.handleSubscribe = handleSubscribe;
        window.handleUnsubscribe = handleUnsubscribe;

        // 전역 스코프에서 함수들을 사용할 수 있도록 설정
        window.countVisitor = countVisitor;
        window.updateVisitorDisplay = updateVisitorDisplay;
        window.getVisitorStats = getVisitorStats;
    </script>
    <style>
        th, td {
            text-overflow: ellipsis; /* 말줄임표 표시 */
        }
    </style>
</head>
<body class="bg-white">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-100 shadow-lg">
            <div class="p-4 flex flex-col h-full">
                <h1 class="text-xl font-bold text-red-500 mb-16">KETEP NEWS CLOUD</h1>
                <nav class="flex-1">

                    <!-- Newsletter Section -->
                    <div class="mb-6">
                        <button onclick="toggleSection('newsletterSection')" 
                                class="flex items-center justify-between w-full text-sm font-semibold text-red-500 uppercase mb-2">
                            <span>뉴스브리핑</span>
                            <svg class="w-4 h-4 transform transition-transform" id="newsletterArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <ul id="newsletterSection" class="space-y-2">
                            <li>
                                <button onclick="setNewsletter(); return false;" 
                                        class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded newsletter-btn">
                                    오늘의 뉴스브리핑
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Topics Section -->
                    <div class="mb-6">
                        <button onclick="toggleSection('topicSection')" 
                                class="flex items-center justify-between w-full text-sm font-semibold text-red-500 uppercase mb-2">
                            <span>아카이빙</span>
                            <svg class="w-4 h-4 transform transition-transform" id="topicArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <ul id="topicSection" class="space-y-2">
                            <!-- Topics will be dynamically populated -->
                        </ul>
                    </div>

                    <!-- 주요사이트 섹션 -->
                    <div class="mb-6">
                        <button onclick="toggleSection('websiteSection')" 
                                class="flex items-center justify-between w-full text-sm font-semibold text-red-500 uppercase mb-2">
                            <span>주요 사이트</span>
                            <svg class="w-4 h-4 transform transition-transform" id="websiteArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <ul id="websiteSection" class="space-y-2">
                            <li>
                                <a href="https://www.ketep.re.kr/brdartcl/boardarticleList.do?brd_id=BDIDX_2U0RE3CxayNmVL12M462Hn&srch_menu_nix=24T94cYy" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    에기평 공지사항
                                </a>
                            </li>
                            <li>
                                <a href="https://energy.ketep.re.kr/globalenergy/site/main/board/energy_news/list" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    에기평 세계에너지시장정보
                                </a>
                            </li>
                            <li>
                                <a href="https://www.motie.go.kr/kor/article/ATCL3f49a5a8c" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    산업부 보도자료
                                </a>
                            </li>
                            <li>
                                <a href="https://www.msit.go.kr/bbs/list.do?sCode=user&mPid=208&mId=307" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    과기정통부 보도자료
                                </a>
                            </li>
                            <li>
                                <a href="https://www.korea.kr/" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    대한민국 정책브리핑
                                </a>
                            </li>
                            <li>
                                <a href="https://www.iea.org/news" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    IEA
                                </a>
                            </li>
                            <li>
                                <a href="https://www.eia.gov/" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    U.S. EIA
                                </a>
                            </li>
                            <li>
                                <a href="https://energy.ec.europa.eu/news_en" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    EU ENERGY
                                </a>
                            </li>
                            <li>
                                <a href="https://www.bloomberg.com/industries/energy" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    BLOOMBERG_ENERGY
                                </a>
                            </li>
                            <li>
                                <a href="https://www.reuters.com/business/energy/" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    REUTERS_ENERGY
                                </a>
                            </li>
                            <li>
                                <a href="https://www.iaea.org/news" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    IAEA
                                </a>
                            </li>
                            <li>
                                <a href="https://www.irena.org/News" 
                                   target="_blank"
                                   rel="noopener noreferrer" 
                                   class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                    IRENA
                                </a>
                            </li>
                        </ul>
                    </div>
                    <!-- 뉴스레터 구독 섹션 수정 -->
                    <div class="mb-6">
                        <h2 class="text-sm font-semibold text-red-500 uppercase mb-2">뉴스브리핑 구독</h2>
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="mb-3">
                                <input type="email" 
                                    id="subscriberEmail" 
                                    placeholder="이메일 주소를 입력하세요" 
                                    class="w-full px-3 py-2 text-sm border rounded focus:outline-none focus:border-red-500">
                            </div>
                            <div class="flex space-x-2">
                                <button id="subscribeBtn"
                                        onclick="handleSubscribe()"
                                        class="flex-1 py-2 text-sm text-white bg-green-500 hover:bg-green-600 rounded transition-colors duration-200">
                                    구독하기
                                </button>
                                <button id="unsubscribeBtn"
                                        onclick="handleUnsubscribe()"
                                        class="flex-1 py-2 text-sm text-white bg-red-500 hover:bg-red-600 rounded transition-colors duration-200">
                                    구독취소
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 방문자 통계 (하단에 배치) -->
                    <div class="mb-6 ">
                        <h3 class="text-sm font-semibold text-red-500 mb-2">방문자 통계</h3>
                        <div class="text-sm text-gray-700">
                            <p>오늘 방문자: <span id="todayVisitors">0</span>명</p>
                            <p>전체 방문자: <span id="totalVisitors">0</span>명</p>
                        </div>
                    </div>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8 bg-white" id="mainContent">
            <iframe id="contentFrame" 
                    style="display: none; width: 100%; height: 100vh; border: none;" 
                    sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"
                    name="newsletter"></iframe>
            <div id="newsContent">
                <!-- Search Bar -->
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex-1 max-w-2xl">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="키워드 또는 언론사 검색" 
                               class="w-full p-3 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                    </div>
                    <button id="exportBtn" class="ml-4 bg-red-500 text-sm text-white px-4 py-2 rounded hover:bg-red-600">
                        선택한 뉴스 내보내기
                    </button>
                </div>

                <!-- Date Range and Page Size Filter -->
                <div class="mb-6 flex justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label class="mr-2 text-sm text-gray-700">기간:</label>
                            <input type="date" id="startDate" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <span class="mx-2">~</span>
                            <input type="date" id="endDate" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-700">페이지당 표시:</label>
                        <select id="itemsPerPageSelect" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-red-500">
                            <option value="10">15개</option>
                            <option value="30">30개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                        </select>
                    </div>
                </div>

                <!-- News Table -->
                <div class="bg-white rounded-lg shadow">
                    <div class="overflow-hidden">
                        <table class="w-full table-fixed">
                            <thead>
                                <tr class="bg-gray-50 text-sm">
                                    <th class="p-3 w-1/12 text-left"><input type="checkbox" id="selectAll"></th>
                                    <th class="p-3 w-2/12 text-left">분야</th>
                                    <th class="p-3 w-8/12 text-left">제목</th>
                                    <th class="p-3 w-2/12 text-left">언론사</th>
                                    <th class="p-3 w-2/12 text-left">날짜</th>
                                </tr>
                            </thead>
                            <tbody id="newsList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="mt-4 flex justify-center" id="pagination">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import Papa from 'https://cdn.skypack.dev/papaparse';
        
        let allNews = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        let currentTopic = null;
        let currentView = 'news'; // 'news' 또는 'newsletter'

        // Fetch and load news data
        async function loadNews() {
            try {
                const response = await fetch('news.json');
                allNews = await response.json();
                updateTopicList();
                displayNews();
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // 토픽 정렬 순서 정의
        const topicOrder = [
            '에기평', '산업부', '원자력', '수소, 연료전지', '태양광', 
            '풍력', '전력', '에너지수요관리', '자원, CCUS', 'ESS', 
            '에너지안전', '기술사업화'
        ];

        // Update topic list in sidebar 함수 수정
        function updateTopicList() {
            const topics = [...new Set(allNews.map(item => item.topic))];
            const topicList = document.getElementById('topicSection');
            
            // 전체 뉴스 버튼
            topicList.innerHTML = `
                <li>
                    <button class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded"
                            onclick="setTopic(null)">
                        전체 뉴스
                    </button>
                </li>
            `;
            
            // 정렬된 토픽 목록 생성
            const sortedTopics = topics
                .filter(topic => topic) // null/undefined 제거
                .sort((a, b) => {
                    const indexA = topicOrder.indexOf(a);
                    const indexB = topicOrder.indexOf(b);
                    // 정의되지 않은 토픽은 맨 뒤로
                    if (indexA === -1) return 1;
                    if (indexB === -1) return -1;
                    return indexA - indexB;
                });
            
            sortedTopics.forEach(topic => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <button class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded"
                            onclick="setTopic('${topic}')">
                        ${topic}
                    </button>
                `;
                topicList.appendChild(li);
            });
            
            updateMenuHighlight();
        }

        // Set topic and update display
        window.setTopic = function(topic) {
            currentView = 'news';
            currentTopic = topic;
            currentPage = 1;
            updateMenuHighlight();
            updateTopicList();
            displayNews();
            showNewsContent();
        };

        // Filter news based on current filters
        function filterNews() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let filtered = allNews.filter(news => {
                if (currentTopic && news.topic !== currentTopic) return false;
                
                const matchSearch = !searchTerm || 
                    news.title.toLowerCase().includes(searchTerm) || 
                    news.press.toLowerCase().includes(searchTerm);

                const newsDate = new Date(news.date).toISOString().split('T')[0];
                const matchStartDate = !startDate || newsDate >= startDate;
                const matchEndDate = !endDate || newsDate <= endDate;

                return matchSearch && matchStartDate && matchEndDate;
            });

            // 날짜 기준 내림차순 정렬
            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;  // 내림차순 정렬
            });

            return filtered;
        }

        // Display filtered news with pagination
        function displayNews() {
            const filteredNews = filterNews();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const newsToDisplay = filteredNews.slice(startIndex, endIndex);

            const tbody = document.getElementById('newsList');
            tbody.innerHTML = '';

            newsToDisplay.forEach(news => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50 text-sm';
                row.innerHTML = `
                    <td class="p-3 w-1/12"><input type="checkbox" class="newsCheckbox" data-url="${news.original_url}"></td>
                    <td class="p-3 w-2/12 truncate" title="${news.topic || '-'}">${news.topic || '-'}</td>
                    <td class="p-3 w-8/12 truncate" title="${news.title}">
                        <a href="${news.original_url}" target="_blank" 
                           class="text-gray-900 hover:underline">
                            ${news.title}
                        </a>
                    </td>
                    <td class="p-3 w-2/12 truncate" title="${news.press}">${news.press}</td>
                    <td class="p-3 w-2/12 truncate">${new Date(news.date).toLocaleDateString()}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(filteredNews.length);
        }

        // 페이지네이션 함수 수정
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // 맨 첫 페이지 버튼
            if (totalPages > 1) {
                const firstButton = document.createElement('button');
                firstButton.innerHTML = '&lt;&lt;'; // 맨 첫 페이지 화살표
                firstButton.className = `mx-1 px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
                firstButton.disabled = currentPage === 1;
                firstButton.onclick = () => {
                    currentPage = 1;
                    displayNews();
                };
                pagination.appendChild(firstButton);
            }

            // 이전 페이지 버튼
            if (totalPages > 1) {
                const prevButton = document.createElement('button');
                prevButton.innerHTML = '&lt;'; // 이전 페이지 화살표
                prevButton.className = `mx-1 px-3 py-1 rounded ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
                prevButton.disabled = currentPage === 1;
                prevButton.onclick = () => {
                    if (currentPage > 1) {
                        currentPage--;
                        displayNews();
                    }
                };
                pagination.appendChild(prevButton);
            }

            // 페이지 번호 버튼
            let startPage = Math.max(1, currentPage - 4);
            let endPage = Math.min(startPage + 9, totalPages);
            
            if (endPage - startPage < 9) {
                startPage = Math.max(1, endPage - 9);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `mx-1 px-3 py-1 rounded ${currentPage === i ? 'bg-red-500 text-sm text-white' : 'bg-gray-200 hover:bg-gray-300'}`;
                button.onclick = () => {
                    currentPage = i;
                    displayNews();
                };
                pagination.appendChild(button);
            }

            // 다음 페이지 버튼
            if (totalPages > 1) {
                const nextButton = document.createElement('button');
                nextButton.innerHTML = '&gt;'; // 다음 페이지 화살표
                nextButton.className = `mx-1 px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
                nextButton.disabled = currentPage === totalPages;
                nextButton.onclick = () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        displayNews();
                    }
                };
                pagination.appendChild(nextButton);
            }

            // 맨 끝 페이지 버튼
            if (totalPages > 1) {
                const lastButton = document.createElement('button');
                lastButton.innerHTML = '&gt;&gt;'; // 맨 끝 페이지 화살표
                lastButton.className = `mx-1 px-3 py-1 rounded ${currentPage === totalPages ? 'bg-gray-100 text-gray-400' : 'bg-gray-200 hover:bg-gray-300'}`;
                lastButton.disabled = currentPage === totalPages;
                lastButton.onclick = () => {
                    currentPage = totalPages;
                    displayNews();
                };
                pagination.appendChild(lastButton);
            }
        }

        // Export selected news to CSV
        async function exportToCSV() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.newsCheckbox:checked');
                
                if (selectedCheckboxes.length === 0) {
                    alert('내보낼 뉴스를 선택해주세요.');
                    return;
                }

                const selectedNews = Array.from(selectedCheckboxes).map(checkbox => {
                    const url = checkbox.dataset.url;
                    const newsItem = allNews.find(news => news.original_url === url);
                    if (!newsItem) return null;
                    
                    return {
                        '분야': newsItem.topic || '',
                        '제목': newsItem.title || '',
                        '언론사': newsItem.press || '',
                        '날짜': new Date(newsItem.date).toLocaleDateString('ko-KR'),
                        'URL': newsItem.original_url || '',
                        '본문': newsItem.content || ''
                    };
                }).filter(item => item !== null);

                if (selectedNews.length === 0) {
                    throw new Error('선택된 뉴스 데이터를 처리할 수 없습니다.');
                }

                // CSV 파일 생성 설정
                const csv = Papa.unparse(selectedNews, {
                    delimiter: ",",
                    header: true,
                    skipEmptyLines: true
                });
                
                // BOM 추가 및 CSV 컨텐츠 생성
                const bomPrefix = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const csvBlob = new Blob([bomPrefix, csv], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // 안전한 파일명 생성
                const safeDate = new Date().toISOString().split('T')[0];
                const fileName = `뉴스목록_${safeDate}.csv`;
                
                // 다운로드 처리
                const downloadUrl = URL.createObjectURL(csvBlob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(downloadUrl);
                }, 100);

            } catch (error) {
                console.error('CSV 내보내기 오류:', error);
                alert(`CSV 파일 생성 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('startDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('endDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('itemsPerPageSelect').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.newsCheckbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 뉴스레터 로드 함수 수정
        window.loadNewsletterContent = function(url) {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            // iframe 로드 이벤트 핸들러
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // base target 설정
                    const baseEl = document.createElement('base');
                    baseEl.target = '_blank';
                    iframeDoc.head.appendChild(baseEl);
                    
                    // 모든 링크에 대해 target="_blank" 추가
                    const links = iframeDoc.getElementsByTagName('a');
                    Array.from(links).forEach(link => {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        
                        // 기존 onclick 이벤트를 제거하고 새 이벤트 리스너 추가
                        link.onclick = function(e) {
                            e.preventDefault();
                            window.open(this.href, '_blank');
                        };
                    });
                } catch (e) {
                    console.error('iframe 설정 중 오류:', e);
                }
            };
            
            iframe.src = url;
            iframe.style.display = 'block';
            newsContent.style.display = 'none';
        };

        // 뉴스 컨텐츠 표시 함수
        function showNewsContent() {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            iframe.style.display = 'none';
            newsContent.style.display = 'block';
        }

        // 뉴스레터 선택 함수 추가
        window.setNewsletter = function() {
            currentView = 'newsletter';
            updateMenuHighlight();
            loadNewsletterContent('newsletter.html');
        };

        // 메뉴 하이라이트 업데이트 함수
        function updateMenuHighlight() {
            // 뉴스레터 버튼 하이라이트
            const newsletterBtn = document.querySelector('.newsletter-btn');
            if (currentView === 'newsletter') {
                newsletterBtn.classList.add('bg-red-100');
            } else {
                newsletterBtn.classList.remove('bg-red-100');
            }

            // 토픽 버튼들 하이라이트
            const topicButtons = document.querySelectorAll('#topicSection button');
            topicButtons.forEach(button => {
                if (currentView === 'news') {
                    if ((currentTopic === null && button.textContent.trim() === '전체 뉴스') ||
                        (button.textContent.trim() === currentTopic)) {
                        button.classList.add('bg-red-100');
                    } else {
                        button.classList.remove('bg-red-100');
                    }
                } else {
                    button.classList.remove('bg-red-100');
                }
            });
        }

        // 섹션 토글 상태 저장
        const sectionStates = {
            newsletterSection: true,
            topicSection: true,
            websiteSection: true
        };

        // 섹션 토글 함수
        window.toggleSection = function(sectionId) {
            const section = document.getElementById(sectionId);
            const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
            
            sectionStates[sectionId] = !sectionStates[sectionId];
            
            if (sectionStates[sectionId]) {
                section.style.display = 'block';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                section.style.display = 'none';
                arrow.style.transform = 'rotate(-90deg)';
            }
        };

        // 초기 상태 설정
        function initializeSections() {
            Object.keys(sectionStates).forEach(sectionId => {
                const section = document.getElementById(sectionId);
                const arrow = document.getElementById(sectionId.replace('Section', 'Arrow'));
                
                if (sectionStates[sectionId]) {
                    section.style.display = 'block';
                    arrow.style.transform = 'rotate(0deg)';
                } else {
                    section.style.display = 'none';
                    arrow.style.transform = 'rotate(-90deg)';
                }
            });
        }

        // Initialize 함수 수정
        function initialize() {
            loadNews();
            currentView = 'news';
            updateMenuHighlight();
            showNewsContent();
            initializeSections();  // 섹션 초기화 추가
            
            // 방문자 카운팅 및 표시 업데이트
            countVisitor();
            updateVisitorDisplay();
        }

        // Initialize 호출
        initialize();
    </script>
</body>
</html>
