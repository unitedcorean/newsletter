<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KETEP NEWS CLOUD</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <!-- Firebase SDK 추가 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, onValue, get, runTransaction } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-analytics.js";

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyDpc7drih9uhEftH8p1kczMU3NNcAwjzB4",
            authDomain: "news-385f0.firebaseapp.com",
            databaseURL: "https://news-385f0-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "news-385f0",
            storageBucket: "news-385f0.firebasestorage.app",
            messagingSenderId: "991807239164",
            appId: "1:991807239164:web:338c4624b8049ac873f879",
            measurementId: "G-W18QS9LPW2"
        };

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getDatabase(app);

        // 방문자 카운팅 함수
        async function countVisitor() {
            const today = new Date().toISOString().split('T')[0];
            
            // 전체 방문자 수 업데이트
            const totalRef = ref(db, 'visitors/total');
            await runTransaction(totalRef, (currentTotal) => {
                return (currentTotal || 0) + 1;
            });
            
            // 오늘 방문자 수 업데이트
            const todayRef = ref(db, `visitors/daily/${today}`);
            await runTransaction(todayRef, (currentCount) => {
                return (currentCount || 0) + 1;
            });
            
            // 월별 통계를 위한 업데이트
            const yearMonth = today.substring(0, 7);
            const monthlyRef = ref(db, `visitors/monthly/${yearMonth}`);
            await runTransaction(monthlyRef, (currentCount) => {
                return (currentCount || 0) + 1;
            });
        }

        // 방문자 수 표시 업데이트 함수
        function updateVisitorDisplay() {
            const today = new Date().toISOString().split('T')[0];
            
            // 전체 방문자 수 가져오기
            const totalRef = ref(db, 'visitors/total');
            onValue(totalRef, (snapshot) => {
                document.getElementById('totalVisitors').textContent = snapshot.val() || 0;
            });
            
            // 오늘 방문자 수 가져오기
            const todayRef = ref(db, `visitors/daily/${today}`);
            onValue(todayRef, (snapshot) => {
                document.getElementById('todayVisitors').textContent = snapshot.val() || 0;
            });
        }

        // 통계 데이터 가져오기 함수
        async function getVisitorStats() {
            const dailyRef = ref(db, 'visitors/daily');
            const monthlyRef = ref(db, 'visitors/monthly');
            
            const [dailySnapshot, monthlySnapshot] = await Promise.all([
                get(dailyRef),
                get(monthlyRef)
            ]);
            
            return {
                daily: dailySnapshot.val(),
                monthly: monthlySnapshot.val()
            };
        }

        // 전역 스코프에서 함수들을 사용할 수 있도록 설정
        window.countVisitor = countVisitor;
        window.updateVisitorDisplay = updateVisitorDisplay;
        window.getVisitorStats = getVisitorStats;
    </script>
</head>
<body class="bg-white">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-100 shadow-lg">
            <div class="p-4 flex flex-col h-full">
                <h1 class="text-xl font-bold text-green-500 mb-16">KETEP NEWS CLOUD</h1>
                <nav class="flex-1">
                    <!-- Newsletter Section -->
                    <h2 class="text-sm font-semibold text-gray-600 uppercase mb-2">뉴스브리핑</h2>
                    <ul class="space-y-2 mb-6">
                        <li>
                            <button onclick="setNewsletter(); return false;" 
                                    class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded newsletter-btn">
                                오늘의 뉴스브리핑
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Topics Section -->
                    <h2 class="text-sm font-semibold text-gray-600 uppercase mb-2">분야별 검색</h2>
                    <ul class="space-y-2" id="topicList">
                        <!-- Topics will be dynamically populated -->
                    </ul>

                    <!-- 주요사이트 섹션 -->
                    <h2 class="text-sm font-semibold text-gray-600 uppercase mt-6 mb-2">주요사이트</h2>
                    <ul class="space-y-2 mb-6">
                        <li>
                            <button onclick="loadWebsite('https://www.ketep.re.kr/brdartcl/boardarticleList.do?brd_id=BDIDX_2U0RE3CxayNmVL12M462Hn&srch_menu_nix=24T94cYy')" 
                                    class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                한국에너지기술평가원
                            </button>
                        </li>
                        <li>
                            <a href="https://www.motie.go.kr/kor/article/ATCL3f49a5a8c" 
                               target="_blank"
                               rel="noopener noreferrer" 
                               class="block w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded website-btn">
                                산업통상자원부
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- 방문자 통계 (하단에 배치) -->
                <div class="mt-8 ">
                    <h3 class="text-sm font-semibold text-gray-600 mb-2">방문자 통계</h3>
                    <div class="text-sm text-gray-700">
                        <p>오늘 방문자: <span id="todayVisitors">0</span>명</p>
                        <p>전체 방문자: <span id="totalVisitors">0</span>명</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8 bg-white" id="mainContent">
            <iframe id="contentFrame" 
                    style="display: none; width: 100%; height: 100vh; border: none;" 
                    sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"
                    name="newsletter"></iframe>
            <div id="newsContent">
                <!-- Search Bar -->
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex-1 max-w-2xl">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="키워드 또는 언론사 검색" 
                               class="w-full p-3 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500 text-sm">
                    </div>
                    <button id="exportBtn" class="ml-4 bg-green-500 text-sm text-white px-4 py-2 rounded hover:bg-green-600">
                        선택한 뉴스 내보내기
                    </button>
                </div>

                <!-- Date Range and Page Size Filter -->
                <div class="mb-6 flex justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label class="mr-2 text-sm text-gray-700">기간:</label>
                            <input type="date" id="startDate" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <span class="mx-2">~</span>
                            <input type="date" id="endDate" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm text-gray-700">페이지당 표시:</label>
                        <select id="itemsPerPageSelect" class="p-2 border rounded text-sm focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <option value="10">10개</option>
                            <option value="30">30개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                        </select>
                    </div>
                </div>

                <!-- News Table -->
                <div class="bg-white rounded-lg shadow">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50 text-sm">
                                    <th class="p-3 w-12"><input type="checkbox" id="selectAll"></th>
                                    <th class="p-3 text-left">분야</th>
                                    <th class="p-3 text-left">제목</th>
                                    <th class="p-3 text-left">언론사</th>
                                    <th class="p-3 text-left">날짜</th>
                                </tr>
                            </thead>
                            <tbody id="newsList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="mt-4 flex justify-center" id="pagination">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import Papa from 'https://cdn.skypack.dev/papaparse';
        
        let allNews = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let currentTopic = null;
        let currentView = 'news'; // 'news' 또는 'newsletter'

        // Fetch and load news data
        async function loadNews() {
            try {
                const response = await fetch('news.json');
                allNews = await response.json();
                updateTopicList();
                displayNews();
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // Update topic list in sidebar
        function updateTopicList() {
            const topics = [...new Set(allNews.map(item => item.topic))];
            const topicList = document.getElementById('topicList');
            topicList.innerHTML = `
                <li>
                    <button class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded"
                            onclick="setTopic(null)">
                        전체 뉴스
                    </button>
                </li>
            `;
            
            topics.forEach(topic => {
                if (!topic) return;
                const li = document.createElement('li');
                li.innerHTML = `
                    <button class="w-full text-left px-4 py-1 text-sm text-gray-700 hover:bg-white rounded"
                            onclick="setTopic('${topic}')">
                        ${topic}
                    </button>
                `;
                topicList.appendChild(li);
            });
            
            updateMenuHighlight();
        }

        // Set topic and update display
        window.setTopic = function(topic) {
            currentView = 'news';
            currentTopic = topic;
            currentPage = 1;
            updateMenuHighlight();
            updateTopicList();
            displayNews();
            showNewsContent();
        };

        // Filter news based on current filters
        function filterNews() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            let filtered = allNews.filter(news => {
                if (currentTopic && news.topic !== currentTopic) return false;
                
                const matchSearch = !searchTerm || 
                    news.title.toLowerCase().includes(searchTerm) || 
                    news.press.toLowerCase().includes(searchTerm);

                const newsDate = new Date(news.date).toISOString().split('T')[0];
                const matchStartDate = !startDate || newsDate >= startDate;
                const matchEndDate = !endDate || newsDate <= endDate;

                return matchSearch && matchStartDate && matchEndDate;
            });

            // 날짜 기준 내림차순 정렬
            filtered.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                return dateB - dateA;  // 내림차순 정렬
            });

            return filtered;
        }

        // Display filtered news with pagination
        function displayNews() {
            const filteredNews = filterNews();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const newsToDisplay = filteredNews.slice(startIndex, endIndex);

            const tbody = document.getElementById('newsList');
            tbody.innerHTML = '';

            newsToDisplay.forEach(news => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50 text-sm';
                row.innerHTML = `
                    <td class="p-3"><input type="checkbox" class="newsCheckbox" data-url="${news.original_url}"></td>
                    <td class="p-3">${news.topic || '-'}</td>
                    <td class="p-3">
                        <a href="${news.original_url}" target="_blank" 
                           class="text-gray-900 hover:underline">
                            ${news.title}
                        </a>
                    </td>
                    <td class="p-3">${news.press}</td>
                    <td class="p-3">${new Date(news.date).toLocaleDateString()}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(filteredNews.length);
        }

        // Update pagination controls
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `mx-1 px-3 py-1 rounded ${currentPage === i ? 'bg-green-500 text-white' : 'bg-gray-200'}`;
                button.onclick = () => {
                    currentPage = i;
                    displayNews();
                };
                pagination.appendChild(button);
            }
        }

        // Export selected news to CSV
        async function exportToCSV() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.newsCheckbox:checked');
                
                if (selectedCheckboxes.length === 0) {
                    alert('내보낼 뉴스를 선택해주세요.');
                    return;
                }

                const selectedNews = Array.from(selectedCheckboxes).map(checkbox => {
                    const url = checkbox.dataset.url;
                    const newsItem = allNews.find(news => news.original_url === url);
                    if (!newsItem) return null;
                    
                    return {
                        '분야': newsItem.topic || '',
                        '제목': newsItem.title || '',
                        '언론사': newsItem.press || '',
                        '날짜': new Date(newsItem.date).toLocaleDateString('ko-KR'),
                        'URL': newsItem.original_url || ''
                    };
                }).filter(item => item !== null);

                if (selectedNews.length === 0) {
                    throw new Error('선택된 뉴스 데이터를 처리할 수 없습니다.');
                }

                // CSV 파일 생성 설정
                const csv = Papa.unparse(selectedNews, {
                    delimiter: ",",
                    header: true,
                    skipEmptyLines: true
                });
                
                // BOM 추가 및 CSV 컨텐츠 생성
                const bomPrefix = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const csvBlob = new Blob([bomPrefix, csv], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // 안전한 파일명 생성
                const safeDate = new Date().toISOString().split('T')[0];
                const fileName = `뉴스목록_${safeDate}.csv`;
                
                // 다운로드 처리
                const downloadUrl = URL.createObjectURL(csvBlob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(downloadUrl);
                }, 100);

            } catch (error) {
                console.error('CSV 내보내기 오류:', error);
                alert(`CSV 파일 생성 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('startDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('endDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('itemsPerPageSelect').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.newsCheckbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 뉴스레터 로드 함수 수정
        window.loadNewsletterContent = function(url) {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            // iframe 로드 이벤트 핸들러
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // base target 설정
                    const baseEl = document.createElement('base');
                    baseEl.target = '_blank';
                    iframeDoc.head.appendChild(baseEl);
                    
                    // 모든 링크에 대해 target="_blank" 추가
                    const links = iframeDoc.getElementsByTagName('a');
                    Array.from(links).forEach(link => {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        
                        // 기존 onclick 이벤트를 제거하고 새 이벤트 리스너 추가
                        link.onclick = function(e) {
                            e.preventDefault();
                            window.open(this.href, '_blank');
                        };
                    });
                } catch (e) {
                    console.error('iframe 설정 중 오류:', e);
                }
            };
            
            iframe.src = url;
            iframe.style.display = 'block';
            newsContent.style.display = 'none';
        };

        // 뉴스 컨텐츠 표시 함수
        function showNewsContent() {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            iframe.style.display = 'none';
            newsContent.style.display = 'block';
        }

        // 뉴스레터 선택 함수 추가
        window.setNewsletter = function() {
            currentView = 'newsletter';
            updateMenuHighlight();
            loadNewsletterContent('newsletter.html');
        };

        // 메뉴 하이라이트 업데이트 함수
        function updateMenuHighlight() {
            // 뉴스레터 버튼 하이라이트
            const newsletterBtn = document.querySelector('.newsletter-btn');
            if (currentView === 'newsletter') {
                newsletterBtn.classList.add('bg-green-100');
            } else {
                newsletterBtn.classList.remove('bg-green-100');
            }

            // 토픽 버튼들 하이라이트
            const topicButtons = document.querySelectorAll('#topicList button');
            topicButtons.forEach(button => {
                if (currentView === 'news') {
                    if ((currentTopic === null && button.textContent.trim() === '전체 뉴스') ||
                        (button.textContent.trim() === currentTopic)) {
                        button.classList.add('bg-green-100');
                    } else {
                        button.classList.remove('bg-green-100');
                    }
                } else {
                    button.classList.remove('bg-green-100');
                }
            });
        }

        // Initialize 함수 수정
        function initialize() {
            loadNews();
            currentView = 'news';
            updateMenuHighlight();
            showNewsContent();
            
            // 방문자 카운팅 및 표시 업데이트
            countVisitor();
            updateVisitorDisplay();
        }

        // Initialize 호출
        initialize();

        // 웹사이트 로드 함수 추가
        window.loadWebsite = function(url) {
            try {
                const iframe = document.getElementById('contentFrame');
                const newsContent = document.getElementById('newsContent');
                
                // iframe 로드 시도
                iframe.src = url;
                iframe.style.display = 'block';
                newsContent.style.display = 'none';
                
                // iframe 로드 실패 시 처리
                iframe.onerror = function() {
                    window.open(url, '_blank');
                };
                
                // iframe 로드 차단 감지
                iframe.onload = function() {
                    try {
                        // iframe 내용 접근 시도
                        const test = iframe.contentWindow.location.href;
                    } catch (e) {
                        // 접근이 차단된 경우 새 창에서 열기
                        console.log('iframe 접근이 차단됨:', e);
                        window.open(url, '_blank');
                    }
                };
            } catch (e) {
                // 예외 발생 시 새 창에서 열기
                console.log('웹사이트 로드 중 오류:', e);
                window.open(url, '_blank');
            }
        };
    </script>
</body>
</html>
