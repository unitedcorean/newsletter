<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>뉴스레터 모음</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div class="w-64 bg-white shadow-lg">
            <div class="p-4">
                <h1 class="text-xl font-bold text-gray-800 mb-4">뉴스레터 모음</h1>
                <nav>
                    <!-- Recent Newsletter Section -->
                    <div class="mb-6">
                        <h2 class="text-sm font-semibold text-gray-600 uppercase mb-2">최근 뉴스레터</h2>
                        <ul class="space-y-2" id="recentNewsletters">
                            <li>
                                <a href="#" onclick="loadNewsletterContent('newsletter.html'); return false;" 
                                   class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded">
                                    최신 뉴스레터
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- Topics Section -->
                    <h2 class="text-sm font-semibold text-gray-600 uppercase mb-2">Topics</h2>
                    <ul class="space-y-2" id="topicList">
                        <!-- Topics will be dynamically populated -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8" id="mainContent">
            <iframe id="contentFrame" 
                    style="display: none; width: 100%; height: 100vh; border: none;" 
                    sandbox="allow-same-origin allow-scripts allow-popups allow-popups-to-escape-sandbox"
                    name="newsletter"></iframe>
            <div id="newsContent">
                <!-- Search Bar -->
                <div class="mb-6 flex justify-between items-center">
                    <div class="flex-1 max-w-2xl">
                        <input type="text" 
                               id="searchInput" 
                               placeholder="키워드 또는 언론사 검색" 
                               class="w-full p-3 border rounded shadow-sm focus:outline-none focus:ring-2 focus:ring-green-500">
                    </div>
                    <button id="exportBtn" class="ml-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                        선택한 뉴스 내보내기
                    </button>
                </div>

                <!-- Date Range and Page Size Filter -->
                <div class="mb-6 flex justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center">
                            <label class="mr-2 text-gray-700">기간:</label>
                            <input type="date" id="startDate" class="p-2 border rounded">
                            <span class="mx-2">~</span>
                            <input type="date" id="endDate" class="p-2 border rounded">
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <label class="text-gray-700">페이지당 표시:</label>
                        <select id="itemsPerPageSelect" class="p-2 border rounded">
                            <option value="15">15개</option>
                            <option value="30">30개</option>
                            <option value="50">50개</option>
                            <option value="100">100개</option>
                        </select>
                    </div>
                </div>

                <!-- News Table -->
                <div class="bg-white rounded-lg shadow">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-4 w-12"><input type="checkbox" id="selectAll"></th>
                                    <th class="p-4 text-left">토픽</th>
                                    <th class="p-4 text-left">제목</th>
                                    <th class="p-4 text-left">언론사</th>
                                    <th class="p-4 text-left">날짜</th>
                                </tr>
                            </thead>
                            <tbody id="newsList">
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="mt-4 flex justify-center" id="pagination">
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import Papa from 'https://cdn.skypack.dev/papaparse';
        
        let allNews = [];
        let currentPage = 1;
        let itemsPerPage = 15;
        let currentTopic = null;

        // Fetch and load news data
        async function loadNews() {
            try {
                const response = await fetch('news.json');
                allNews = await response.json();
                updateTopicList();
                displayNews();
            } catch (error) {
                console.error('Error loading news:', error);
            }
        }

        // Update topic list in sidebar
        function updateTopicList() {
            const topics = [...new Set(allNews.map(item => item.topic))];
            const topicList = document.getElementById('topicList');
            topicList.innerHTML = `
                <li>
                    <button class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 ${!currentTopic ? 'bg-green-100' : ''}"
                            onclick="setTopic(null)">
                        전체 뉴스
                    </button>
                </li>
            `;
            
            topics.forEach(topic => {
                if (!topic) return;
                const li = document.createElement('li');
                li.innerHTML = `
                    <button class="w-full text-left px-4 py-2 rounded hover:bg-gray-100 ${currentTopic === topic ? 'bg-green-100' : ''}"
                            onclick="setTopic('${topic}')">
                        ${topic}
                    </button>
                `;
                topicList.appendChild(li);
            });
        }

        // Set topic and update display
        window.setTopic = function(topic) {
            currentTopic = topic;
            currentPage = 1;
            updateTopicList();
            displayNews();
            showNewsContent();
        };

        // Filter news based on current filters
        function filterNews() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            return allNews.filter(news => {
                if (currentTopic && news.topic !== currentTopic) return false;
                
                const matchSearch = !searchTerm || 
                    news.title.toLowerCase().includes(searchTerm) || 
                    news.press.toLowerCase().includes(searchTerm);

                const newsDate = new Date(news.date).toISOString().split('T')[0];
                const matchStartDate = !startDate || newsDate >= startDate;
                const matchEndDate = !endDate || newsDate <= endDate;

                return matchSearch && matchStartDate && matchEndDate;
            });
        }

        // Display filtered news with pagination
        function displayNews() {
            const filteredNews = filterNews();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const newsToDisplay = filteredNews.slice(startIndex, endIndex);

            const tbody = document.getElementById('newsList');
            tbody.innerHTML = '';

            newsToDisplay.forEach(news => {
                const row = document.createElement('tr');
                row.className = 'border-t hover:bg-gray-50';
                row.innerHTML = `
                    <td class="p-4"><input type="checkbox" class="newsCheckbox" data-url="${news.original_url}"></td>
                    <td class="p-4">${news.topic || '-'}</td>
                    <td class="p-4">
                        <a href="${news.original_url}" target="_blank" 
                           class="text-blue-600 hover:underline">
                            ${news.title}
                        </a>
                    </td>
                    <td class="p-4">${news.press}</td>
                    <td class="p-4">${new Date(news.date).toLocaleDateString()}</td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(filteredNews.length);
        }

        // Update pagination controls
        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            for (let i = 1; i <= totalPages; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `mx-1 px-3 py-1 rounded ${currentPage === i ? 'bg-green-500 text-white' : 'bg-gray-200'}`;
                button.onclick = () => {
                    currentPage = i;
                    displayNews();
                };
                pagination.appendChild(button);
            }
        }

        // Export selected news to CSV
        async function exportToCSV() {
            try {
                const selectedCheckboxes = document.querySelectorAll('.newsCheckbox:checked');
                
                if (selectedCheckboxes.length === 0) {
                    alert('내보낼 뉴스를 선택해주세요.');
                    return;
                }

                const selectedNews = Array.from(selectedCheckboxes).map(checkbox => {
                    const url = checkbox.dataset.url;
                    const newsItem = allNews.find(news => news.original_url === url);
                    if (!newsItem) return null;
                    
                    return {
                        '토픽': newsItem.topic || '',
                        '제목': newsItem.title || '',
                        '언론사': newsItem.press || '',
                        '날짜': new Date(newsItem.date).toLocaleDateString('ko-KR'),
                        'URL': newsItem.original_url || ''
                    };
                }).filter(item => item !== null);

                if (selectedNews.length === 0) {
                    throw new Error('선택된 뉴스 데이터를 처리할 수 없습니다.');
                }

                // CSV 파일 생성 설정
                const csv = Papa.unparse(selectedNews, {
                    delimiter: ",",
                    header: true,
                    skipEmptyLines: true
                });
                
                // BOM 추가 및 CSV 컨텐츠 생성
                const bomPrefix = new Uint8Array([0xEF, 0xBB, 0xBF]);
                const csvBlob = new Blob([bomPrefix, csv], { 
                    type: 'text/csv;charset=utf-8;' 
                });
                
                // 안전한 파일명 생성
                const safeDate = new Date().toISOString().split('T')[0];
                const fileName = `뉴스목록_${safeDate}.csv`;
                
                // 다운로드 처리
                const downloadUrl = URL.createObjectURL(csvBlob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = fileName;
                
                document.body.appendChild(link);
                link.click();
                
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(downloadUrl);
                }, 100);

            } catch (error) {
                console.error('CSV 내보내기 오류:', error);
                alert(`CSV 파일 생성 중 오류가 발생했습니다: ${error.message}`);
            }
        }

        // Event listeners
        document.getElementById('searchInput').addEventListener('input', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('startDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('endDate').addEventListener('change', () => {
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('itemsPerPageSelect').addEventListener('change', (e) => {
            itemsPerPage = parseInt(e.target.value);
            currentPage = 1;
            displayNews();
        });
        
        document.getElementById('exportBtn').addEventListener('click', exportToCSV);
        
        document.getElementById('selectAll').addEventListener('change', (e) => {
            document.querySelectorAll('.newsCheckbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        });

        // 뉴스레터 로드 함수 수정
        window.loadNewsletterContent = function(url) {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            // iframe 로드 이벤트 핸들러
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // base target 설정
                    const baseEl = document.createElement('base');
                    baseEl.target = '_blank';
                    iframeDoc.head.appendChild(baseEl);
                    
                    // 모든 링크에 대해 target="_blank" 추가
                    const links = iframeDoc.getElementsByTagName('a');
                    Array.from(links).forEach(link => {
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        
                        // 기존 onclick 이벤트를 제거하고 새 이벤트 리스너 추가
                        link.onclick = function(e) {
                            e.preventDefault();
                            window.open(this.href, '_blank');
                        };
                    });
                } catch (e) {
                    console.error('iframe 설정 중 오류:', e);
                }
            };
            
            iframe.src = url;
            iframe.style.display = 'block';
            newsContent.style.display = 'none';
        };

        // 뉴스 컨텐츠 표시 함수
        function showNewsContent() {
            const iframe = document.getElementById('contentFrame');
            const newsContent = document.getElementById('newsContent');
            
            iframe.style.display = 'none';
            newsContent.style.display = 'block';
        }

        // Initialize with history state
        function initialize() {
            loadNews();
            showNewsContent(); // 초기 화면을 뉴스 목록으로 설정
        }

        // Initialize 호출 수정
        initialize();
    </script>
</body>
</html>
